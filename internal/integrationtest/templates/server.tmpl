// Code generated for integration tests. DO NOT EDIT.
package main

import (
    "errors"
    "fmt"
    "log"
    "log/slog"
    "net/http"
    "os"
    "time"

    "github.com/cubahno/connexions/v2/pkg/api"
    "github.com/cubahno/connexions/v2/pkg/loader"

    // Imports to ensure dependencies are available
    _ "github.com/go-playground/validator/v10"
    _ "github.com/google/uuid"

    // Service imports
{{range .ServiceImports}}	_ "{{.}}"
{{end}})

func main() {
    logLevel := slog.LevelInfo
    switch os.Getenv("LOG_LEVEL") {
    case "debug":
        logLevel = slog.LevelDebug
    case "warn":
        logLevel = slog.LevelWarn
    case "error":
        logLevel = slog.LevelError
    }
    handler := slog.NewTextHandler(os.Stderr, &slog.HandlerOptions{Level: logLevel})
    logger := slog.New(handler)
    slog.SetDefault(logger)

    // NewRouter includes all middleware (RequestID, RealIP, Logger, Duration, Recoverer, Timeout)
    router := api.NewRouter()

    _ = api.CreateHealthRoutes(router)
    _ = api.CreateHomeRoutes(router)
    _ = api.CreateServiceRoutes(router)

    loader.LoadAll(router)

    port := os.Getenv("PORT")
    if port == "" {
        port = "2200"
    }
    addr := fmt.Sprintf(":%s", port)

    server := &http.Server{
        Addr:         addr,
        Handler:      router,
        ReadTimeout:  15 * time.Second,
        WriteTimeout: 15 * time.Second,
        IdleTimeout:  60 * time.Second,
    }

    log.Printf("Starting batch server on %s with %d services", addr, {{.ServiceCount}})
    if err := server.ListenAndServe(); err != nil && !errors.Is(err, http.ErrServerClosed) {
        log.Fatalf("Server failed to start: %v", err)
    }
}

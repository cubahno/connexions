package main

import (
	"log"
	"os"
	"path/filepath"
	"sort"
	"strings"

	"github.com/cubahno/connexions/v2/internal/contexts"
	"github.com/cubahno/connexions/v2/pkg/config"
)

// main generates resources/contexts/fake.yml from available fake functions.
func main() {
	cwd, err := os.Getwd()
	if err != nil {
		log.Fatalf("Error getting current working directory: %v", err)
	}
	paths := config.NewPaths(cwd)
	outputFile := filepath.Join(paths.Resources, "contexts", "fake.yml")

	// Get all fake functions
	fakes := contexts.ContextFunctions0Arg

	// Organize fakes into primitives and objects
	primitives := make([]string, 0)
	objects := make(map[string][]string)

	for name := range fakes {
		if strings.Contains(name, ".") {
			parts := strings.SplitN(name, ".", 2)
			objectName := parts[0]
			fieldName := parts[1]
			objects[objectName] = append(objects[objectName], fieldName)
		} else {
			primitives = append(primitives, name)
		}
	}

	// Sort primitives
	sort.Strings(primitives)

	// Sort object names
	objectNames := make([]string, 0, len(objects))
	for name := range objects {
		objectNames = append(objectNames, name)
	}
	sort.Strings(objectNames)

	// Sort fields within each object
	for _, fields := range objects {
		sort.Strings(fields)
	}

	// Build YAML content
	var sb strings.Builder

	// Write header comment
	sb.WriteString("# This file is generated by connexions. DO NOT EDIT.\n")
	sb.WriteString("# The full path (e.g., 'fake:internet.url') is used for proper function resolution\n\n")

	// Write primitives
	for _, name := range primitives {
		sb.WriteString(name + `: "fake:` + name + `"` + "\n")
	}

	// Write objects
	for _, objName := range objectNames {
		sb.WriteString("\n" + objName + ":\n")

		fields := objects[objName]
		for _, field := range fields {
			fullPath := objName + "." + field
			sb.WriteString("  " + field + `: "fake:` + fullPath + `"` + "\n")
		}
	}

	// Write the content to file
	if err := os.WriteFile(outputFile, []byte(sb.String()), 0644); err != nil {
		log.Fatalf("Error writing file: %v", err)
	}

	log.Printf("Successfully updated %s with %d fake functions!", outputFile, len(fakes))
}

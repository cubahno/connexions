name: CI

on:
  push:
    branches: 'master'
    paths-ignore:
      - 'docs/**'
  pull_request:
    branches: '**'
    paths-ignore:
      - 'docs/**'

permissions: read-all

jobs:
  fetch-specs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Cache specs
        id: cache-specs
        uses: actions/cache@v4
        with:
          path: testdata/specs
          key: specs-${{ hashFiles('Makefile') }}
      - name: Fetch specs
        if: steps.cache-specs.outputs.cache-hit != 'true'
        run: make fetch-specs
      - name: Upload specs artifact
        uses: actions/upload-artifact@v4
        with:
          name: specs
          path: testdata/specs
          retention-days: 1

  linter:
    if: github.event_name == 'pull_request'
    needs: fetch-specs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Download specs artifact
        uses: actions/download-artifact@v4
        with:
          name: specs
          path: testdata/specs
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.5"
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.10.1
          args: --timeout 10m

  linter-openapi:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fetch PR head
        run: git fetch origin ${{ github.event.pull_request.head.sha }}
      - name: Lint OpenAPI spec
        uses: github/super-linter@v7
        env:
          VALIDATE_ALL_CODEBASE: true
          VALIDATE_OPENAPI: true
          FILTER_REGEX_INCLUDE: resources/openapi.yml

  test:
    if: github.event_name == 'pull_request'
    needs: fetch-specs
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download specs artifact
      uses: actions/download-artifact@v4
      with:
        name: specs
        path: testdata/specs

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: "1.25.5"

    - name: Build
      run: go build -v ./...

    - run: go mod download && go mod tidy && go mod verify
    - run: git --no-pager diff --exit-code

    - run: go vet ./...
    - run: git --no-pager diff --exit-code

    - run: go fmt ./...
    - run: git --no-pager diff --exit-code

    - name: Check make generate produces no diff
      run: |
        make generate
        git --no-pager diff --exit-code

    - name: Unit tests
      run: make test-with-check-coverage

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: coverage.out

  prepare-integration-matrix:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up matrix
      id: set-matrix
      run: |
        # Read specs from file, skip comments and empty lines, split into 4 batches
        specs=$(grep -v '^#' .github/ci-specs.txt | grep -v '^$' | tr '\n' ' ')
        specs_array=($specs)
        total=${#specs_array[@]}
        batch_size=$(( (total + 3) / 4 ))

        matrix='{"include":['
        for i in 0 1 2 3; do
          start=$((i * batch_size))
          batch_specs=""
          for j in $(seq $start $((start + batch_size - 1))); do
            if [ $j -lt $total ]; then
              batch_specs="$batch_specs ${specs_array[$j]}"
            fi
          done
          if [ -n "$batch_specs" ]; then
            matrix="$matrix{\"batch\":$((i+1)),\"specs\":\"$batch_specs\"},"
          fi
        done
        matrix="${matrix%,}]}"
        echo "matrix=$matrix" >> $GITHUB_OUTPUT

  integration-test:
    if: github.event_name == 'pull_request'
    needs: [fetch-specs, prepare-integration-matrix]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-integration-matrix.outputs.matrix) }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download specs artifact
      uses: actions/download-artifact@v4
      with:
        name: specs
        path: testdata/specs

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: "1.25.5"

    - name: Integration Tests (Batch ${{ matrix.batch }})
      run: |
        NO_CACHE=1 SPECS="${{ matrix.specs }}" make test-integration

  # Only runs on push to master to update the coverage badge
  generate_badge:
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    needs: fetch-specs
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download specs artifact
      uses: actions/download-artifact@v4
      with:
        name: specs
        path: testdata/specs

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: "1.25.5"

    - name: Run tests and get coverage
      run: |
        make test-with-check-coverage
        total=$(go tool cover -func=coverage.out | awk '/^total:/{printf "%d", $3}' | tr -d '%')
        echo "TOTAL_COVERAGE=$total" >> $GITHUB_ENV

    - name: Make coverage badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.GIST_WRITER }}
        gistID: 4110782af3ec09dd1ebabc3304756f1f
        filename: covbadge.json
        label: Coverage
        message: ${{ env.TOTAL_COVERAGE }}%
        minColorRange: 50
        maxColorRange: 90
        valColorRange: ${{ env.TOTAL_COVERAGE }}

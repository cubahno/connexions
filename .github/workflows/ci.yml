name: CI

on:
  push:
    branches: 'master'
    paths-ignore:
      - 'docs/**'
  pull_request:
    branches: '**'
    paths-ignore:
      - 'docs/**'

permissions: read-all

jobs:
  linter:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.5"
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.10.1
          args: --timeout 10m

  linter-openapi:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Lint OpenAPI spec
        uses: github/super-linter@v7
        env:
          VALIDATE_ALL_CODEBASE: true
          VALIDATE_OPENAPI: true
          FILTER_REGEX_INCLUDE: resources/openapi.yml

  test:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: "1.25.5"

    - name: Fetch specs for embed
      run: make fetch-specs

    - name: Build
      run: go build -v ./...

    - run: go mod download && go mod tidy && go mod verify
    - run: git --no-pager diff --exit-code

    - run: go vet ./...
    - run: git --no-pager diff --exit-code

    - run: go fmt ./...
    - run: git --no-pager diff --exit-code

    - name: Check make generate produces no diff
      run: |
        make generate
        git --no-pager diff --exit-code

    - name: Unit tests
      run: make test-with-check-coverage

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: coverage.out

    - name: Integration Tests
      run: |
        # Random sample of 250 specs on PRs
        NO_CACHE=1 RANDOM_SPECS=250 MAX_CONCURRENCY=10 make test-integration

  # Only runs on push to master to update the coverage badge
  generate_badge:
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: "1.25.5"

    - name: Fetch specs for embed
      run: make fetch-specs

    - name: Run tests and get coverage
      run: |
        make test-with-check-coverage
        total=$(go tool cover -func=coverage.out | awk '/^total:/{printf "%d", $3}' | tr -d '%')
        echo "TOTAL_COVERAGE=$total" >> $GITHUB_ENV

    - name: Make coverage badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.GIST_WRITER }}
        gistID: 4110782af3ec09dd1ebabc3304756f1f
        filename: covbadge.json
        label: Coverage
        message: ${{ env.TOTAL_COVERAGE }}%
        minColorRange: 50
        maxColorRange: 90
        valColorRange: ${{ env.TOTAL_COVERAGE }}
